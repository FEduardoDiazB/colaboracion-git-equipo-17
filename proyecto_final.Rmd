---
title: "Proyecto final módulo 1"
author: "Equipo - 17"
output: html_document
---

# Integrantes:

+ Francisco Eduardo Díaz Barrios. Rol: Administrador
+ Erick Muñiz Morales. Rol: Colaborador 1 
+ Hendrix Roberto Olvera Barbecho. Rol: Colaborador 2


```{r}
install.packages("paletteer")
```

```{r}
library(dplyr)
library(readr)
library(ggplot2)
library(patchwork)
library(tidyr)
library(purrr)
library(tibble)
library(RColorBrewer)
library(paletteer)
```

```{r}
mis_datos <- readr::read_csv("datos_proyecto.csv")
```

### Instrucciones Colaborador 1: 

Desde su máquina crear chunks de código R en el archivo "proyecto_final.Rmd" (que obtuvo del Administrador) que calculen la media de x, la media de y, la desviación estándar de x, la desviación estándar de y, la correlación de Pearson entre x y y, PARA CADA SUBCONJUNTO, usando ciclos for. Hacer commit y push del código al repositorio del administrador y hacer un pull request.


```{r}
# Los separamos por subconjuntos
subconjunto <- unique(mis_datos$subconjunto)

for (elemento in subconjunto) {
  datos_a_calcular <- mis_datos[mis_datos$subconjunto == elemento,]
  datos_a_calcular$media_x <- mean(datos_a_calcular$x)
  datos_a_calcular$media_y <- mean(datos_a_calcular$y)
  datos_a_calcular$dev_x <- sd(datos_a_calcular$x)
  datos_a_calcular$dev_y <- sd(datos_a_calcular$y)
  
  data_frame_elemento <- data.frame(subconjunto = c(elemento),
                                    media_x = c(mean(datos_a_calcular$x)),
                                    media_y = c(mean(datos_a_calcular$y)),
                                    dev_x = c(sd(datos_a_calcular$x)),
                                    dev_y = c(sd(datos_a_calcular$y)),
                                    cor = c( cor(datos_a_calcular$x , datos_a_calcular$y, method = 'pearson' ) )
                                    )
  
  print(data_frame_elemento)
}

```

### Instrucciones Colaborador 2: 

Desde su máquina crear chunks de código R en el archivo "proyecto_final.Rmd" (que obtuvo del Administrador) que calculen la media de x, la media de y, la desviación estándar de x, la desviación estándar de y, la correlación de Pearson entre x y y, PARA CADA SUBCONJUNTO, usando verbos de la librería {dplyr}. Debe corregir la línea author: "Equipo - n" con el número correcto de equipo y agregar los nombres completos de los integrantes en la sección de # Integrantes. Hacer commit y push del código al repositorio del administrador y hacer un pull request.

```{r}
mis_datos %>% 
  dplyr::group_by(subconjunto) %>% 
  dplyr::summarise(media_x = mean(x), 
            media_y = mean(y),
            dev_est_x = sd(x),
            dev_est_y = sd(y),
            cor_xy = cor(x,y,method = 'pearson'))
```

### Instrucciones Admin:

Desde su máquina crear chunks de código R en el archivo "proyecto_final.Rmd" (que obtuvo del Administrador) que trafiquen con ggplot las parejas de valores (x,y) DE CADA SUBCONJUNTO. Hacer commit y push del código al repositorio del administrador y revisar los pull requests de los colaboradores 1 y 2.

```{r}
mis_datos <- mis_datos %>% mutate(subconjunto_g = as.character(subconjunto))
```

```{r}
mis_datos %>% ggplot(aes(x=x, y=y, color=subconjunto_g)) +
  geom_point(size=0.5) +
  facet_wrap(~ subconjunto_g)+
  scale_color_paletteer_d("palettetown::armaldo")+
  labs(x = element_blank(), y = element_blank()) +
  theme_minimal() + 
  theme(legend.position="none",
        axis.text = element_blank())
#ggsave("proyecto_final_modulo1_p1_e17.pdf", width = 8, height = 8)
```

#### Comentario de colaborador 1: 

Se puede notar que las propiedades de la estadistica descriptiva calculadas (promedio, mediana) son casi identicas pero al graficarlo la distribución de los datos de cada subconjunto son diferentes entre sí. 

# Seccion 2

### Subsección 1 : Prueba de Bechdel

La prueba de Bechdel es un método que se usa para evaluar la representación de las mujeres en películas, series u otras obras narrativas. Para aprobarla, la obra debe cumplir tres criterios: (1) tener al menos dos personajes femeninos con nombre, (2) que estos personajes conversen entre sí en algún momento, y (3) que su diálogo no gire en torno a un hombre (por ejemplo, relaciones románticas o familiares). Fue propuesta por Alison Bechdel, destacando la falta de desarrollo de personajes femeninos en muchas producciones, aunque no mide la calidad ni la igualdad de género de manera exhaustiva.

En dicho dataframe se tienen algunas columnas como:

`budget_2013`: Presupuesto en dólares ajustados a la inflación de 2013

`domgross_2013`: Recaudación nacional (EE.UU.) en dólares ajustados a la inflación de 2013

`intgross_2013`: Recaudación internacional total (es decir, mundial) en dólares a la inflación de 2013

En la columna clean_test encontrará los valores

ok = Pasa la prueba dubious = Se duda si pasa la prueba men = Las mujeres sólo hablan acerca de hombres notalk = Las mujeres no se hablan entre sí nowomen = menos de dos mujeres

#### Actividad 1: Cargue en un objeto de R el contenido del archivo "prueba_bechdel.csv"

```{r}
library(dplyr)
datos_bechdel <-readr::read_csv("prueba_bechdel.csv")
```
#### Actividad 2: Use alguna de las funciones case_when o if_else de {dplyr} para cambiar los valores de la columna clean_test

```{r}
datos_bechdel <- datos_bechdel |> 
  dplyr::mutate(clean_test = dplyr::case_when(clean_test == "ok" ~ "pasa",
                                              clean_test == "dubious" ~ "dudosamente",
                                              clean_test == "men" ~ "discurso_hombres",
                                              clean_test == "notalk" ~ "silencio",
                                              clean_test == "nowomen" ~ "sin_mujeres",
                                              TRUE ~ clean_test)) # Safe case en caso de volver a correr este chunk

unique(datos_bechdel$clean_test)
```
#### Actividad 3: Use alguna de las funciones case_when o if_else de {dplyr} para cambiar los valores de la columna binary

FAIL -> no_pasa PASS -> si_pasa


```{r}
datos_bechdel <- datos_bechdel |> 
  dplyr::mutate(binary = dplyr::case_when(binary == "PASS" ~ "si_pasa",
                                          binary == "FAIL" ~ "no_pasa",
                                          TRUE ~ binary)) # Safe case en caso de volver a correr este chunk

unique(datos_bechdel$binary)
```

#### Actividad 4: Haga una gráfica con funciones de {ggplot2} que muestre la composición de observaciones que sí pasaron y no pasaron la prueba de Bechdel

```{r}
library(ggplot2)

numero_completo <- function(x) format(x, big.mark = ",", scientific = FALSE)

# Presupuesto 2023 
datos_bechdel |> 
  dplyr::mutate(PruebaBechel = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary)) |>
  ggplot2::ggplot(aes(budget_2013, fill = PruebaBechel) ) + 
    geom_histogram() +
     ggtitle("Cantidad de películas según su presupuesto en 2023.") + 
    labs(fill = "Prueba de Bechel") + 
    labs(y = "Frecuencia", x = "Presupuesto en dólares") + 
    scale_x_continuous(labels = numero_completo, transform = "log10")
```
```{r}
datos_bechdel |> 
  dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary)) |>
  ggplot2::ggplot(aes(domgross_2013, fill = binary) ) + 
    geom_histogram() +
     ggtitle("Cantidad de películas según su \n recaudación nacional (EE.UU.) en 2013.") + 
    labs(fill = "Prueba de Bechel") + 
    labs(y = "Frecuencia", x = "Recaudación en dólares") + 
    scale_x_continuous(labels = numero_completo, transform = "log10")
```
```{r}
datos_bechdel |> 
  dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary)) |>
  ggplot2::ggplot(aes(intgross_2013, fill = binary) ) + 
    geom_histogram() +
     ggtitle("Histograma: Cantidad de películas según su \n recaudación internacional en 2013.") + 
    labs(fill = "Prueba de Bechel") + 
    labs(y = "Frecuencia", x = "Recaudación en dólares") + 
    scale_x_continuous(labels = numero_completo, transform = "log10")
```

#### Actividad 5: Haga una gráfica con funciones de {ggplot2} que muestre la composición de observaciones que sí pasaron y no pasaron la prueba de Bechdel, con respecto al año

```{r}
datos_bechdel |> 
  dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary)) |>
  ggplot2::ggplot(aes(x = year, y = budget_2013, color = binary) ) + 
    geom_point() +
     ggtitle("Películas según su presupuesto y año de producción \n ajustado a la inflación en 2013.") + 
    labs(color = "Prueba de Bechel") + 
    labs(y = "Prespuesto en dólares", x = "Año") + 
    scale_y_continuous(labels = numero_completo, transform = "log10")
```
```{r}
datos_bechdel |> 
  dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary)) |>
  ggplot2::ggplot(aes(x = year, y = domgross_2013, color = binary) ) + 
    geom_point() +
     ggtitle("Películas según su recaudación nacional (EE.UU.) y año de producción \n ajustado a la inflación de 2013.") + 
    labs(color = "Prueba de Bechel") + 
    labs(y = "Prespuesto en dólares", x = "Año") + 
    scale_y_continuous(labels = numero_completo, transform = "log10")
```

```{r}
datos_bechdel |> 
  dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary)) |>
  ggplot2::ggplot(aes(x = year, y = intgross_2013, color = binary) ) + 
    geom_point() +
     ggtitle("Películas según su recaudación internacional y año de producción \n ajustado a la inflación de 2013.") + 
    labs(color = "Prueba de Bechel") + 
    labs(y = "Prespuesto en dólares", x = "Año") + 
    scale_y_continuous(labels = numero_completo, transform = "log10")
```

#### Actividad 6: Haga una gráfica con funciones de {ggplot2} que muestre la composición de observaciones que pasaron, dudosamente, sólo hablaban de hombres, no hablaban entre sí y no hay mujeres.

```{r}
datos_bechdel |> 
   dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary)) |>
  ggplot2::ggplot(aes(x = clean_test, y = budget_2013, color = binary) ) + 
    geom_violin(aes(group = clean_test), alpha = 0.4) +
     ggtitle("Películas según presupuesto ajustado a la inflación en 2013.") + 
    labs(color = "Prueba de Bechel") + 
    labs(y = "Prespuesto en dólares") + 
    scale_y_continuous(labels = numero_completo, transform = "log10")
```
```{r}
datos_bechdel |> 
   dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary)) |>
  ggplot2::ggplot(aes(x = clean_test, y = domgross_2013, color = binary) ) + 
    geom_violin(aes(group = clean_test), alpha = 0.4) +
     ggtitle("Películas según recaudación nacional (EE.UU.) \n ajustado a la inflación en 2013.") + 
    labs(color = "Prueba de Bechel") + 
    labs(y = "Prespuesto en dólares") + 
    scale_y_continuous(labels = numero_completo, transform = "log10")
```
```{r}
datos_bechdel |> 
   dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary)) |>
  ggplot2::ggplot(aes(x = clean_test, y = intgross_2013, color = binary) ) + 
    geom_violin(aes(group = clean_test), alpha = 0.4) +
     ggtitle("Películas según recaudación internacional \n ajustado a la inflación en 2013.") + 
    labs(color = "Prueba de Bechel") + 
    labs(y = "Prespuesto en dólares") + 
    scale_y_continuous(labels = numero_completo, transform = "log10")
```
#### Actividad 7: Haga una gráfica con funciones de {ggplot2} que muestre la composición de observaciones que pasaron, dudosamente, sólo hablaban de hombres, no hablaban entre sí y no hay mujeres, con respecto al año.

```{r}
datos_bechdel |> 
  dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary)) |>
  ggplot2::ggplot(aes(x = year, y = budget_2013, color = binary, shape = clean_test) ) + 
    geom_point() +
     ggtitle("Películas según su presupuesto y año de producción \n ajustado a la inflación en 2013.") + 
    labs(color = "Prueba de Bechel") + 
    labs(y = "Prespuesto en dólares", x = "Año") + 
    scale_y_continuous(labels = numero_completo, transform = "log10")
```
```{r}
datos_bechdel |> 
  dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary)) |>
  ggplot2::ggplot(aes(x = year, y = domgross_2013, color = binary, shape = clean_test) ) + 
    geom_point() +
     ggtitle("Películas según su recaudación nacional (EE.UU.) y año de producción \n ajustado a la inflación en 2013.") + 
    labs(color = "Prueba de Bechel") + 
    labs(y = "Prespuesto en dólares", x = "Año") + 
    scale_y_continuous(labels = numero_completo, transform = "log10")
```
```{r}
datos_bechdel |> 
  dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary)) |>
  ggplot2::ggplot(aes(x = year, y = intgross_2013, color = binary, shape = clean_test) ) + 
    geom_point() +
     ggtitle("Películas según su recaudación internacional y año de producción \n ajustado a la inflación en 2013.") + 
    labs(color = "Prueba de Bechel") + 
    labs(y = "Prespuesto en dólares", x = "Año") + 
    scale_y_continuous(labels = numero_completo, transform = "log10")
```
#### Actividad 8: Haga una gráfica con funciones de {ggplot2} que muestre la relación entre el presupuesto de la obra con la ganancia de la obra en función de si paso o no la prueba de Bechdel. ¿Puede hacer algún tipo de afirmación?

```{r}
datos_bechdel |> 
  dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary)) |>
  ggplot2::ggplot(aes(x = budget_2013, color = binary) ) + 
    geom_point(aes(y=intgross_2013 + domgross_2013)) + 
    scale_y_continuous(labels = numero_completo, transform = "log10") + 
    scale_x_continuous(labels = numero_completo, transform = "log10") + 
    labs(color = "Prueba de Bechel") + 
    labs(x = "Prespuesto en dólares", y = "Recaudación nacional e internacional en dólares") + 
    ggtitle("Relación entre el prespuesto con las ganacias (recuadación nacional más internacional \n en función de la Prueba de Bechel") + 
    geom_abline(intercept = 0, slope = 1)
```
De la gráfica de arriba, una buena cantidad de películas son rentables, es decir
que se obtiene más dinero de la recaudación que del presupuesto sin importar la 
prueba de Bechel. 


```{r}
datos_bechdel |> 
  dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary),
                es_rentable = budget_2013 < domgross_2013 + intgross_2013) |>
  dplyr::filter(!is.na(budget_2013) & !is.na(domgross_2013) & !is.na(intgross_2013)) |> # Solo hay 18 casos
  dplyr::count(binary, es_rentable)
```

Del cuadro anterior, hay más películas que no pasan la prueba de Bechel y que son rentables. 

De esto, solo se puede concluir que pasar la prueba de Bechel no representa una pérdida.


#### Actividad 9: Haga dos gráficas adicionales con funciones de {ggplot2} que considere interesantes.

1 - Hagamos una gráfica comparando el porcentaje de la rentabilidad de las películas, 
es decir, que tanto se ganó en porcentaje de ambas recaudaciones respecto 
a la inversión inicial (domgross_2013 + intgross_2013 / budget_2013).

```{r}
datos_bechdel |> 
  dplyr::filter(!is.na(budget_2013) & !is.na(domgross_2013) & !is.na(intgross_2013)) |> # Solo hay 18 casos
  dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary),
                rentabilidad = (domgross_2013 + intgross_2013) / budget_2013 ) |>
   ggplot2::ggplot(aes(rentabilidad, fill = binary) ) + 
    geom_density() +
     ggtitle("Cantidad de películas según su \n recaudación nacional (EE.UU.) en 2013.") + 
    labs(fill = "Prueba de Bechel") + 
    labs(y = "Densidad", x = "Recaudación en porcentaje") + 
    scale_x_continuous(labels = numero_completo, transform = "log10")
``` 
```{r}
datos_bechdel |> 
  dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary),
                rentabilidad = (domgross_2013 + intgross_2013) / budget_2013) |>
  dplyr::filter(!is.na(budget_2013) & !is.na(domgross_2013) & !is.na(intgross_2013)) |> # Solo hay 18 casos
  dplyr::group_by(binary) |>
  dplyr::summarise(median(rentabilidad))
```
Dado que la gráfica nos muestran aparentes casos extremos, es preferible usar la mediana. 
Bajo esta medidana, las películas que pasan la pruea de Bechel resultan ser más rentables. 


2 - Queremos ver si pasando la prueba de Bechel, se obtiene mayor rentabilidad 
con la recaudación internacional o nacional. 

```{r}
datos_bechdel |> 
  dplyr::mutate(binary = dplyr::case_when(binary == "si_pasa" ~ "Pasa",
                                          binary == "no_pasa" ~ "No pasa",
                                          TRUE ~ binary)) |>
  ggplot2::ggplot(aes(color = binary) ) + 
    geom_point(aes(y=intgross_2013, x=domgross_2013)) + 
    scale_y_continuous(labels = numero_completo, transform = "log10") + 
    scale_x_continuous(labels = numero_completo, transform = "log10") + 
    labs(color = "Prueba de Bechel") + 
    labs(x = "Recaudación nacional en dólares", y = "Recaudación internacional en dólares") + 
    ggtitle("Relación entre la recaudación nacional e internacional \n en función de la Prueba de Bechel") + 
    geom_abline(intercept = 0, slope = 1)
```

Del gráfico anterior, notamos que no hay una diferencia significativa a las 
recaudaciones respecto a si es internacional o nacional. 

Sin embargo, del mismo gráfico, podemos ver que, en general, siempre se obtuvo una 
mayor recaudación internacional que nacional. 


# Subsección 2

## Librerias

```{r}
library(dplyr)
library(fivethirtyeight)
library(ggplot2)
```

## Datos

```{r}
datos <- fivethirtyeight::airline_safety

datos |> head()
```

# Actividad 1

Con funciones de la librería {dplyr} para obtener el número total de incidentes, número total de accidentes fatales y el número total de muertes en el periodo de 1985 a 2014.

```{r}
datos %>% summarise(incidentes_1 = sum(incidents_85_99 +incidents_00_14))
```

```{r}
datos %>% summarise(accidentes_1 = sum(fatal_accidents_85_99 + fatal_accidents_00_14))
```

```{r}
datos %>% summarise(fallecimientos_1 = sum(fatalities_85_99 + fatalities_00_14))
```

# Actividad 2

Obtenga las 10 aerolíneas que han tenido el mayor número de incidentes. Haga una visualización que permita identificar a éstas. ¿Hay algún cambio en este top 10 antes y después del año 2000?

El número de incidentes disminuye radicalmente después del año 2000, el orden del top cambia, ademas de tener nuevas aerolineas y otras desaparecen.

```{r}
datos %>% group_by(airline) %>%  
  summarise(incidentes_tot = sum(incidents_85_99 +incidents_00_14)) %>% 
  slice_max(n = 10, order_by = incidentes_tot, with_ties = TRUE)

datos %>% group_by(airline) %>%  
  summarise(incidentes_85_99 = sum(incidents_85_99)) %>% 
  slice_max(n = 10, order_by = incidentes_85_99, with_ties = TRUE)

datos %>% group_by(airline) %>%  
  summarise(incidentes_00_14 = sum(incidents_00_14)) %>% 
  slice_max(n = 10, order_by = incidentes_00_14, with_ties = TRUE)
```

```{r}
datos %>% 
  dplyr::group_by(airline) %>% 
  dplyr::summarise(incidentes_tot = sum(incidents_85_99 +incidents_00_14)) %>% 
  slice_max(n = 10, order_by = incidentes_tot, with_ties = TRUE) %>%
  ggplot() +
  geom_bar(aes(y = airline, x = incidentes_tot), stat = "identity", fill="#FF9999") + 
  labs(title = "Incidentes mayores totales", x = "Aerolineas", y = "Incidentes") + 
  theme(plot.title.position = "plot")

datos %>% 
  dplyr::group_by(airline) %>% 
  dplyr::summarise(incidentes_tot = sum(incidents_85_99)) %>% 
  slice_max(n = 10, order_by = incidentes_tot, with_ties = TRUE) %>%
  ggplot() +
  geom_bar(aes(y = airline, x = incidentes_tot), stat = "identity", fill="#FF1079") + 
  labs(title = "Incidentes 1985-1999", x = "Aerolineas", y = "Incidentes") + 
  theme(plot.title.position = "plot")

datos %>% 
  dplyr::group_by(airline) %>% 
  dplyr::summarise(incidentes_tot = sum(incidents_00_14)) %>% 
  slice_max(n = 10, order_by = incidentes_tot, with_ties = TRUE) %>%
  ggplot() +
  geom_bar(aes(y = airline, x = incidentes_tot), stat = "identity", fill="#AA2089") + 
  labs(title = "Incidentes 2000-2014", x = "Aerolineas", y = "Incidentes") + 
  theme(plot.title.position = "plot")
```

# Actividad 3

Obtenga las 10 aerolíneas que han tenido el menor número de incidentes. Haga una visualización que permita identificar a éstas. ¿Hay algún cambio en este top 10 antes y después del año 2000?

Después del año 2000 en el top solo se tiene una aerolinea con un incidente, fuera de eso las demas no tienen incidentes, antes de dicho año solo tres aerolineas tienen cero incidentes.

Solo aerolineas se mantienen en el top, de estas tres, todas menos Virgin Atlantic se mantienen con cero incidentes.

```{r}
datos %>% group_by(airline) %>%  
  summarise(incidentes_tot = sum(incidents_85_99 +incidents_00_14)) %>% 
  slice_min(n = 10, order_by = incidentes_tot, with_ties = TRUE)

datos %>% group_by(airline) %>%  
  summarise(incidentes_85_99 = sum(incidents_85_99)) %>% 
  slice_min(n = 10, order_by = incidentes_85_99, with_ties = TRUE)

datos %>% group_by(airline) %>%  
  summarise(incidentes_00_14 = sum(incidents_00_14)) %>% 
  slice_min(n = 10, order_by = incidentes_00_14, with_ties = TRUE)
```

```{r}
datos %>% 
  dplyr::group_by(airline) %>% 
  dplyr::summarise(incidentes_tot = sum(incidents_85_99 +incidents_00_14)) %>% 
  slice_min(n = 10, order_by = incidentes_tot, with_ties = TRUE) %>%
  ggplot() +
  geom_bar(aes(y = airline, x = incidentes_tot), stat = "identity", fill="#458B00") + 
  labs(title = "Incidentes min Totales", x = "Aerolineas", y = "Incidentes") + 
  theme(plot.title.position = "plot")

datos %>% 
  dplyr::group_by(airline) %>% 
  dplyr::summarise(incidentes_tot = sum(incidents_85_99)) %>% 
  slice_min(n = 10, order_by = incidentes_tot, with_ties = TRUE) %>%
  ggplot() +
  geom_bar(aes(y = airline, x = incidentes_tot), stat = "identity", fill="#66CD00") + 
  labs(title = "Incidentes 1985-1999", x = "Aerolineas", y = "Incidentes") + 
  theme(plot.title.position = "plot")

datos %>% 
  dplyr::group_by(airline) %>% 
  dplyr::summarise(incidentes_tot = sum(incidents_85_99)) %>% 
  slice_min(n = 10, order_by = incidentes_tot, with_ties = TRUE) %>%
  ggplot() +
  geom_bar(aes(y = airline, x = incidentes_tot), stat = "identity", fill="#9BCD9B") + 
  labs(title = "Incidentes 2000-2014", x = "Aerolineas", y = "Incidentes") + 
  theme(plot.title.position = "plot")
```

# Actividad 4

Obtenga las 10 aerolíneas que han tenido el mayor número de muertes. Haga una visualización que permita identificar a éstas. ¿Hay algún cambio en este top 10 antes y después del año 2000?

Después del año 2000 se tiene una disminución de fallecimientos, el orden e integrantes del top cambio como con los anteriores.

```{r}
datos %>% group_by(airline) %>%  
  summarise(fallecimientos_tot = sum(fatalities_85_99 + fatalities_00_14)) %>% 
  slice_max(n = 10, order_by = fallecimientos_tot, with_ties = TRUE)

datos %>% group_by(airline) %>%  
  summarise(fallecimientos_85_99 = sum(fatalities_85_99)) %>% 
  slice_max(n = 10, order_by = fallecimientos_85_99, with_ties = TRUE)

datos %>% group_by(airline) %>%  
  summarise(fallecimientos_00_14 = sum(fatalities_00_14)) %>% 
  slice_max(n = 10, order_by = fallecimientos_00_14, with_ties = TRUE)
```

```{r}
datos %>% 
  dplyr::group_by(airline) %>% 
  dplyr::summarise(fallecimientos_tot = sum(fatalities_85_99 + fatalities_00_14)) %>% 
  slice_max(n = 10, order_by = fallecimientos_tot, with_ties = TRUE) %>%
  ggplot() +
  geom_bar(aes(y = airline, x = fallecimientos_tot), stat = "identity", fill="#009ACD") + 
  labs(title = "Fallecimientos mayores Totales", x = "Aerolineas", y = "Fallecimientos") + 
  theme(plot.title.position = "plot")

datos %>% 
  dplyr::group_by(airline) %>% 
  dplyr::summarise(fallecimientos_tot = sum(fatalities_85_99)) %>% 
  slice_max(n = 10, order_by = fallecimientos_tot, with_ties = TRUE) %>%
  ggplot() +
  geom_bar(aes(y = airline, x = fallecimientos_tot), stat = "identity", fill="#00BFFF") + 
  labs(title = "Fallecimientos 1985-1999", x = "Aerolineas", y = "Fallecimientos") + 
  theme(plot.title.position = "plot")

datos %>% 
  dplyr::group_by(airline) %>% 
  dplyr::summarise(fallecimientos_tot = sum(fatalities_00_14)) %>% 
  slice_max(n = 10, order_by = fallecimientos_tot, with_ties = TRUE) %>%
  ggplot() +
  geom_bar(aes(y = airline, x = fallecimientos_tot), stat = "identity", fill="#1874CD") + 
  labs(title = "Fallecimientos 2000-2014", x = "Aerolineas", y = "Fallecimientos") + 
  theme(plot.title.position = "plot")
```

# Actividad 5

Obtenga las 10 aerolíneas que han tenido el menor número de muertes. Haga una visualización que permita identificar a éstas. ¿Hay algún cambio en este top 10 antes y después del año 2000?

En este top se tuvo lo esperado de cambios, sin embargo todos compartren que el número de fallecimientos es 0, después del año 2000 de 17 aerolineas se paso a 32 con cero fallecimientos, ademas que solo comparten 12 aerolineas en común.
Excluyendo el caso donde son 0, tenemos que la única aerolínea que después del cambio de milenio que siguen presentando fallecimientos es TACA.  

```{r}
datos %>% group_by(airline) %>%  
  summarise(fallecimientos_tot = sum(fatalities_85_99 + fatalities_00_14)) %>% 
  slice_min(n = 10, order_by = fallecimientos_tot, with_ties = TRUE)

datos %>% group_by(airline) %>%  
  summarise(fallecimientos_85_99 = sum(fatalities_85_99)) %>% 
  slice_min(n = 10, order_by = fallecimientos_85_99, with_ties = TRUE)

datos %>% group_by(airline) %>%  
  summarise(fallecimientos_00_14 = sum(fatalities_00_14)) %>% 
  slice_min(n = 10, order_by = fallecimientos_00_14, with_ties = TRUE)
```


```{r}
datos %>% group_by(airline) %>%  
  dplyr::filter(fatalities_85_99 != 0 & fatalities_00_14 != 0) %>%
  summarise(fallecimientos_tot = sum(fatalities_85_99 + fatalities_00_14)) %>% 
  slice_min(n = 10, order_by = fallecimientos_tot, with_ties = TRUE)

datos %>% group_by(airline) %>%  
  dplyr::filter(fatalities_85_99 != 0) %>%
  summarise(fallecimientos_85_99 = sum(fatalities_85_99)) %>% 
  slice_min(n = 10, order_by = fallecimientos_85_99, with_ties = TRUE)

datos %>% group_by(airline) %>%  
  dplyr::filter(fatalities_00_14 != 0) %>%
  summarise(fallecimientos_00_14 = sum(fatalities_00_14)) %>% 
  slice_min(n = 10, order_by = fallecimientos_00_14, with_ties = TRUE)
```


```{r}
datos %>% 
  dplyr::group_by(airline) %>% 
  dplyr::filter(fatalities_85_99 != 0 & fatalities_00_14 != 0) %>%
  dplyr::summarise(fallecimientos_tot = sum(fatalities_85_99 + fatalities_00_14)) %>% 
  slice_min(n = 10, order_by = fallecimientos_tot, with_ties = TRUE) %>%
  ggplot() +
  geom_bar(aes(y = airline, x = fallecimientos_tot), stat = "identity", fill="#EEAD0E") + 
  labs(title = "Fallecimientos menores Totales", x = "Aerolineas", y = "Fallecimientos") + 
  theme(plot.title.position = "plot")

datos %>% 
  dplyr::group_by(airline) %>% 
  dplyr::filter(fatalities_85_99 != 0) %>%
  dplyr::summarise(fallecimientos_tot = sum(fatalities_85_99)) %>% 
  slice_min(n = 10, order_by = fallecimientos_tot, with_ties = TRUE) %>%
  ggplot() +
  geom_bar(aes(y = airline, x = fallecimientos_tot), stat = "identity", fill="#CDAD00") + 
  labs(title = "Fallecimientos 1985-1999", x = "Aerolineas", y = "Fallecimientos") + 
  theme(plot.title.position = "plot")

datos %>% 
  dplyr::group_by(airline) %>% 
  dplyr::filter(fatalities_00_14 != 0) %>%
  dplyr::summarise(fallecimientos_tot = sum(fatalities_00_14)) %>% 
  slice_min(n = 10, order_by = fallecimientos_tot, with_ties = TRUE) %>%
  ggplot() +
  geom_bar(aes(y = airline, x = fallecimientos_tot), stat = "identity", fill="#EEB422") + 
  labs(title = "Fallecimientos 2000-2014", x = "Aerolineas", y = "Fallecimientos") + 
  theme(plot.title.position = "plot")
```




### Subsección 3: Calidad del café

```{r}
datos_cafe <- readr::read_csv("coffee_ratings.csv")
datos_cafe %>% head()
```
#### Actividad 1

¿Cuántos renglones y cuántas columnas tiene el objeto datos?

```{r}
num_columnas <- datos_cafe %>% ncol()
num_filas <- datos_cafe %>% nrow()
print(paste("El número de columnas es:",  
            (num_columnas) , 
            "y el número de filas es: " ,
            num_filas))
```

#### Actividad 2.

Genere una nueva columna llamada continent que tome los valores "north-america", "south-america", "europe", "asia", "africa", "oceania" en función de los valores de la columna country_of_origin

```{r}
#Encontramos los nombres de los paises en los datos
 datos_cafe$country_of_origin %>% unique() 
```

```{r}
 Africa <- c("Ethiopia", "Uganda","Tanzania, United Republic Of", "Kenya", 
             "Burundi", "Rwanda","Zambia", "Cote d?Ivoire",
             "Mauritius")
NAmerica <- c("Guatemala", "United States", "United States (Hawaii)",
              "Costa Rica", "Mexico", "Honduras", "Nicaragua",
              "Panama", "El Salvador", "United States (Puerto Rico)",
              "Haiti")
SAmerica <- c("Brazil", "Peru","Colombia","Ecuador")
Asia <- c("Indonesia","China", "Taiwan","Thailand",
          "Japan", "Vietnam", "Philippines","Malawi","Laos",
          "Myanmar","India")
Oceania <- c( "Papua New Guinea")
pais <- datos_cafe$country_of_origin
continent <- dplyr::case_when(
  pais %in% Africa ~ "africa",
  pais %in% NAmerica ~ "north-america",
  pais %in% SAmerica~ "south-america",
  pais %in% Asia ~ "asia",
  pais %in% Oceania ~ "oceania",
  is.na(pais) ~ NA_character_,
  TRUE ~ "otro"
)

#continent %>% unique()

```

```{r}
datos_cafe <- datos_cafe %>% mutate(continent)
datos_cafe %>% head()
```

#### Actividad 3

Elabore una visualización con {ggplot2} que identifique alguna relación entre las columnas total_cup_points, aroma, flavor, acidity EN UN MISMO CANVAS.

```{r}
datos_cafe_a3 <- datos_cafe %>% dplyr::select(aroma,acidity,flavor,total_cup_points)

datos_cafe_ga3 <- datos_cafe_a3 %>%
  pivot_longer(cols = c("aroma", "flavor", "acidity"),names_to = "caracteristica", values_to = "valor")
```

```{r}
matrizcorr_to_dfgraf <- function(matriz_correlacion){
  matriz_correlacion %>% as.data.frame() %>% rownames_to_column(var = "Var1") %>%
    pivot_longer(cols = -Var1, names_to = "Var2", values_to = "correlacion")
}
```

```{r}
cor_matriz_a3_g <- cor(datos_cafe_a3[,c("aroma", "acidity", "flavor" , "total_cup_points")])
matriz_graf_a3 <- cor_matriz_a3_g %>% matrizcorr_to_dfgraf()
```



```{r}
matriz_graf_a3 %>%
  ggplot(aes(x = Var1, y = Var2, fill = correlacion)) +
  geom_tile(color = "black") +
  geom_text(aes(label = round(correlacion, 2)), color = "black") +
  scale_fill_gradient(low = "lightyellow1", high = "blue3", limits = c(0.6, 0.9), name = "R")+ 
  labs(
    title = "Correlación entre características y puntos totales por taza de café",
    x = element_blank(), y = element_blank()) +
  theme_minimal() 

```


#### Actividad 4

Elabore una visualización con {ggplot2} que identifique alguna relación entre las columnas total_cup_points, aroma, flavor, acidity por continent EN UN MISMO CANVAS.

```{r}
datos_cafe_a4 <- datos_cafe %>% select(aroma, acidity, flavor, continent, total_cup_points) 
datos_cafe_a4$total_cup_points <- datos_cafe_a4$total_cup_points/10  
datos_cafe_f_a4 <-datos_cafe_a4 %>% filter(!is.na(continent),!is.na(total_cup_points),!is.na(acidity), !is.na(aroma), !is.na(flavor))
datos_cafe_ga4 <- datos_cafe_f_a4 %>%
  pivot_longer(cols = c("aroma", "flavor", "acidity", "total_cup_points"),names_to = "caracteristica",values_to = "valor")
#datos_cafe_ga4 <- datos_cafe_ga4 %>% filter(!is.na(continent),!is.na(total_cup_points),!is.na(valor))
```

```{r}
graf_a4_b1 <- datos_cafe_ga4 %>% ggplot(aes(x = continent, y = valor, fill = continent)) +
  geom_boxplot(alpha = 0.7, outlier.size = 0.5) +
  facet_wrap(~ caracteristica, scales = "fixed", nrow = 1) +
  labs(title = "Características gustativas y T.C.P. reescalados* por continente", x = element_blank() ,
       y = "Valor", fill = "Continente", caption = "* Los T.C.P. fueron reescalados como: (T.C.P./10), para fines visuales pero no pierden información comparativa.") +
  theme_minimal() +
  ylim(5,10)+
  #ylim(65,95)
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.border = element_rect(color = "black", fill = NA),  
        strip.background = element_rect(fill = "honeydew", color = "black"),  
        ) 
graf_a4_b1
```



#### Actividad 5

Elabore una visualización con {ggplot2} que identifique alguna relación entre las columnas total_cup_points, aroma, flavor, acidity por species EN UN MISMO CANVAS.

```{r}
datos_cafe_a5 <- datos_cafe %>% select(aroma, acidity, flavor, total_cup_points, species)
datos_cafe_a5$total_cup_points <- datos_cafe_a5$total_cup_points/10 
datos_cafe_f_a5 <- datos_cafe_a5 %>% filter(!is.na(species),!is.na(total_cup_points),!is.na(acidity), !is.na(flavor),!is.na(aroma))
datos_cafe_ga5 <- datos_cafe_a5 %>% 
  pivot_longer( cols = c("aroma", "acidity", "flavor", "total_cup_points"), names_to = "caracteristica", values_to = "valor")
```


```{r}
graf_a5_b1 <- datos_cafe_ga5 %>% ggplot(aes(x = species, y = valor, fill = species)) +
  geom_boxplot(alpha = 0.7, outlier.size = 0.5) +
  facet_wrap(~ caracteristica, scales = "fixed", nrow = 1) +
  labs(title = "Características gustativas y T.C.P. reescalados* por especie", x = element_blank() ,
       y = "Valor", fill = "Continente", caption = "* Los T.C.P. fueron reescalados como: (T.C.P./10), para fines visuales pero no pierden información comparativa.") +
  theme_minimal() +
  ylim(5,10)+
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.border = element_rect(color = "black", fill = NA),  
        strip.background = element_rect(fill = "lightgoldenrod1", color = "black"),  
        ) 
graf_a5_b1
```


#### Actividad 6

Elabore una visualización con {ggplot2} que identifique alguna relación entre las columnas total_cup_points, altitude_mean_meters y aroma EN UN MISMO CANVAS.

```{r}
datos_cafe_a6 <- datos_cafe %>% select(aroma, total_cup_points, altitude_mean_meters)
datos_cafe_f_a6 <- datos_cafe_a6 %>% filter(!is.na(total_cup_points),!is.na(altitude_mean_meters),!is.na(aroma)) #esta linea no elimina los NAs?
datos_cafe_ga6 <- datos_cafe_f_a6 %>% 
  pivot_longer( cols = c("aroma", "altitude_mean_meters"), names_to = "caracteristica", values_to = "valor")
#datos_cafe_ga6
```


```{r}
cor_matriz_a6_g <- cor(datos_cafe_f_a6[,c("aroma", "altitude_mean_meters",  "total_cup_points")])
matriz_graf_a6 <- cor_matriz_a6_g %>% matrizcorr_to_dfgraf()
```


```{r}
matriz_graf_a6 %>%
  ggplot(aes(x = Var1, y = Var2, fill = correlacion)) +
  geom_tile(color = "black") +
  geom_text(aes(label = round(correlacion, 2)), color = "black") +
  scale_fill_gradient(low = "lightyellow1", high = "darkgreen",  name = "R")+ 
  labs(
    title = "Correlación entre aroma, altitud y puntos totales por taza de café",
    x = element_blank(), y = element_blank()) +
  theme_minimal() 

```

#### Actividad 7

Elabore una visualización con {ggplot2} que identifique alguna relación entre las columnas total_cup_points, altitude_mean_meters y aroma por continent EN UN MISMO CANVAS.


```{r}
datos_cafe_a7 <- datos_cafe %>% select(aroma, total_cup_points, altitude_mean_meters, continent)
datos_cafe_f_a7 <- datos_cafe_a7 %>% filter(!is.na(total_cup_points),!is.na(altitude_mean_meters),!is.na(aroma), !is.na(continent))
datos_cafe_ga7 <- datos_cafe_f_a7 %>% 
  pivot_longer( cols = c("aroma", "altitude_mean_meters"), names_to = "caracteristica", values_to = "valor")
#datos_cafe_ga7
```



```{r}

graf_a7_b1 <- datos_cafe_f_a7 %>% ggplot(aes(x = continent, y = aroma, fill = continent)) +
  geom_boxplot(alpha = 0.7, outlier.size = 0.5) +
  labs(title = "", subtitle = "Aroma" , x = element_blank() ,
       y = "Valor", fill = "Continente") +
  theme_minimal() +
  ylim(5,10)+
  theme(legend.position = "none",
        axis.text.x = element_blank())  

graf_a7_b2 <- datos_cafe_f_a7 %>% ggplot(aes(x = continent, y = altitude_mean_meters, fill = continent)) +
  geom_boxplot(alpha = 0.7, outlier.size = 0.5) +
  labs(title ="Características por continente", x = element_blank() ,
       y = "Altitud promedio [m]", fill = "Continente") +
  theme_minimal() +
  ylim(0,2500)+
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        legend.justification = "left")  

graf_a7_b3 <- ggplot(datos_cafe_f_a7 , aes(x = continent, y = total_cup_points , fill = continent)) +
  geom_boxplot(alpha = 0.7, outlier.size = 0.5) +
  labs(x = element_blank(), y = "Total Cup Points", fill = "Continente") +
  theme_minimal() +
  ylim(65,95)+
  theme(legend.position = "none",
         axis.text.x = element_blank())  
graf_a7_b2 + graf_a7_b1 / graf_a7_b3
```


#### Actividad 8

Elabore una visualización con {ggplot2} que identifique alguna relación entre las columnas total_cup_points, altitude_mean_meters y aroma por species EN UN MISMO CANVAS.

```{r}
datos_cafe_a8 <- datos_cafe %>% select(aroma, total_cup_points, altitude_mean_meters, species)
datos_cafe_f_a8 <- datos_cafe_a8 %>% filter(!is.na(total_cup_points),!is.na(altitude_mean_meters),!is.na(aroma), !is.na(species))
datos_cafe_ga8 <- datos_cafe_f_a8 %>% 
  pivot_longer( cols = c("aroma", "altitude_mean_meters"), names_to = "caracteristica", values_to = "valor")
#datos_cafe_f_a8
```


```{r}
graf_a8_b1 <- datos_cafe_f_a8 %>% ggplot(aes(x = species, y = aroma, fill = species)) +
  geom_boxplot(alpha = 0.7, outlier.size = 0.5) +
  #facet_wrap(~ caracteristica, scales = "free_y") +
  labs(subtitle = "Aroma" , x = element_blank() ,
       y = "Valor") +
  theme_minimal() +
  ylim(6.5,9.5)+
  #ylim(65,95)
  theme(legend.position = "none",
        axis.text.x = element_blank())  

graf_a8_b2 <- datos_cafe_f_a8 %>% ggplot(aes(x = species, y = altitude_mean_meters, fill = species)) +
  geom_boxplot(alpha = 0.7, outlier.size = 0.5) +
  #facet_wrap(~ caracteristica, scales = "free_y") +
  labs(title ="Características por continente", x = element_blank() ,
       y = "Altitud promedio [m]") +
  theme_minimal() +
  ylim(0,2500)+
  theme(legend.position = "bottom",
        axis.text.x = element_blank(),
        legend.justification = "left")    

graf_a8_b3 <- datos_cafe_f_a8  %>% ggplot(aes(x = species, y = total_cup_points , fill = species)) +
  geom_boxplot(alpha = 0.7, outlier.size = 0.5) +
  #facet_wrap(~ caracteristica, scales = "free_y") +
  labs(x = element_blank(), y = "Total Cup Points", fill = "Continente") +
  theme_minimal() +
  #ylim(5,10)+
  ylim(65,95)+
  theme(legend.position = "none",
         axis.text.x = element_blank())  
graf_a8_b2 + graf_a8_b1 / graf_a8_b3
```


#### Actividad 9

Elabore una visualización con {ggplot2} entre sweetness y total_cup_points de los 5 países con mayor calificación de balance.
 
 
```{r}
datos_cafe_a9 <- datos_cafe %>% select(sweetness, total_cup_points,country_of_origin, balance)
datos_cafe_ga9 <- datos_cafe_a9 %>% arrange(desc(balance)) %>% distinct(country_of_origin, .keep_all = TRUE) %>% head(5)
#datos_cafe_ga9
```


```{r}
datos_cafe_ga9 %>%
  ggplot(aes(x = 0, y =total_cup_points, xend = sweetness, yend = total_cup_points)) + 
  geom_segment(aes(color=country_of_origin,
               linewidth = balance)) +
  geom_label(aes(y = total_cup_points, x = sweetness + 0.2,
                 label = `balance`), size = 3) +
  theme_minimal()+
  labs(x ="Valor de dulzura",y="Total Cup Points",
       color = "País",
       linewidth = "Balance")+
  ggtitle("Dulzura y T.C.P. entre países con mejor balance")+
  coord_cartesian(xlim = c(8, 10.5))+
  scale_color_brewer(palette = "Paired")
```




#### Actividad 10

Elabore una visualización con {ggplot2} entre acidity y total_cup_points de los 5 países con menor calificación de aftertaste.

```{r}
datos_cafe_a10 <- datos_cafe %>% select(aftertaste, total_cup_points,country_of_origin, acidity)
datos_cafe_ga10 <- datos_cafe_a10 %>% arrange(desc(aftertaste)) %>% distinct(country_of_origin, .keep_all = TRUE) %>% head(5)
#datos_cafe_ga10
```



```{r}
datos_cafe_ga10 %>%
  ggplot(aes(x = 0, y =total_cup_points, xend = acidity, yend = total_cup_points)) + 
  geom_segment(aes(color=country_of_origin,
               linewidth = aftertaste)) +
  geom_label(aes(y = total_cup_points, x = acidity + 0.1,
                 label = `aftertaste`), size = 3) +
  theme_minimal()+
  labs(x ="Valor de acidez",y="Total Cup Points",
       color = "País",
       linewidth = "Retrogusto")+
  ggtitle("Acidez y T.C.P. entre países con mejor retrogusto")+
  coord_cartesian(xlim = c(8, 9))+
  scale_color_brewer(palette = "Set2")
```